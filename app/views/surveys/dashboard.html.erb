<div class="max-w-7xl mx-auto">
  <!-- Header Section -->
  <div class="mb-8 flex flex-col lg:flex-row lg:justify-between lg:items-start gap-4">
    <div class="flex-1 min-w-0">
      <h1 class="text-3xl font-bold text-gray-900"><%= @survey.title %></h1>
      <p class="mt-2 text-sm text-gray-600"><%= @survey.description %></p>
      <div class="mt-2 flex items-center gap-4">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= @survey.published? ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' %>">
          <%= @survey.status.humanize %>
        </span>
        <% if @assignments.any? %>
          <span class="text-sm text-gray-500">
            <%= @assignments.completed.count %>/<%= @assignments.count %> responses (<%= @metrics[:response_rate] %>%)
          </span>
        <% end %>
      </div>
    </div>
    <div class="flex flex-wrap gap-3 lg:flex-nowrap" data-controller="ai-insights">
      <%= form_with url: ai_analysis_survey_path(@survey), method: :post, local: false,
          data: {
            "ai-insights-target" => "form",
            "action" => "submit->ai-insights#start"
          } do |form| %>
        <%= form.submit "🤖 Generate AI Insights",
            data: { "ai-insights-target" => "button" },
            class: "inline-flex items-center px-4 py-2 border border-purple-300 shadow-sm text-sm font-medium rounded-md text-purple-700 bg-purple-50 hover:bg-purple-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 whitespace-nowrap" %>
      <% end %>
      <%= link_to "📊 Insights History", insights_survey_path(@survey), class: "inline-flex items-center px-4 py-2 border border-indigo-300 shadow-sm text-sm font-medium rounded-md text-indigo-700 bg-indigo-50 hover:bg-indigo-100 whitespace-nowrap" %>
      <%= link_to "📈 Sentiment Analysis", sentiment_analysis_survey_path(@survey), class: "inline-flex items-center px-4 py-2 border border-pink-300 shadow-sm text-sm font-medium rounded-md text-pink-700 bg-pink-50 hover:bg-pink-100 whitespace-nowrap" %>
      <%= link_to "← Back to Survey", @survey, class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 whitespace-nowrap" %>
    </div>
  </div>

  <!-- AI Insights Container -->
  <div id="ai_insights_content" class="mb-6">
    <!-- AI insights will appear here -->
  </div>

  <!-- Progress indicator area with subscription -->
  <div id="data-generation-status-container">
    <%= render 'data_generation_status', survey: @survey %>
  </div>

  <!-- Dashboard Content Container - This will be replaced via Turbo Streams -->
  <%= render 'dashboard_content', survey: @survey, assignments: @assignments, questions: @questions, metrics: @metrics %>

  <!-- Assignment Generation Section -->
  <div class="bg-white shadow overflow-hidden sm:rounded-lg mt-8">
    <div class="px-4 py-5 sm:px-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900">Generate Test Data</h3>
      <p class="mt-1 max-w-2xl text-sm text-gray-500">Create additional assignments and responses for testing</p>
    </div>
    <div class="border-t border-gray-200 px-6 py-4">
      <%= form_with url: generate_data_survey_path(@survey), method: :post, local: false, class: "space-y-4" do |form| %>
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
          <div>
            <%= form.label :assignments_count, "Number of Assignments", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.number_field :assignments_count,
                value: 10,
                min: 1,
                max: 100,
                class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
            <p class="mt-1 text-xs text-gray-500">How many users to assign</p>
          </div>

          <div>
            <%= form.label :responses_count, "Number of Responses", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.number_field :responses_count,
                value: 7,
                min: 0,
                class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
            <p class="mt-1 text-xs text-gray-500">How many should complete it</p>
          </div>

          <div class="flex items-end space-x-2">
            <%= form.submit "Generate Data",
                class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 flex-1 justify-center" %>
          </div>
        </div>
      <% end %>

      <% if @assignments.any? %>
        <div class="mt-4 pt-4 border-t border-gray-200">
          <%= button_to reset_assignments_survey_path(@survey),
              method: :delete,
              data: {
                confirm: "Are you sure? This will permanently delete all assignments and responses for this survey."
              },
              class: "inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" do %>
            🗑️ Reset All Data
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>